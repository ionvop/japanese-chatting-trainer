<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="manifest" href="manifest.json">
        <style>
            body {
                margin: 0rem;
                padding: 0rem;
                background-color: #111;
                color: #fff;
                font-family: Arial, Helvetica, sans-serif;
            }

            button {
                padding: 1rem;
                background-color: #050;
                color: #fff;
                border: none;
                border-radius: 1rem;
                font-family: Arial, Helvetica, sans-serif;
                font-size: 1rem;
            }

            input {
                padding: 1rem;
                width: 100%;
                background-color: transparent;
                color: #fff;
                border: none;
                border-bottom: 1px solid #aaa;
                font-family: Arial, Helvetica, sans-serif;
                font-size: 1rem;

                &:focus {
                    outline: none;
                    border-bottom: 1px solid #0a0;
                }
            }

            textarea {
                padding: 1rem;
                width: 100%;
                height: 10rem;
                resize: vertical;
                background-color: transparent;
                color: #fff;
                border: none;
                border-bottom: 1px solid #aaa;
                font-family: Arial, Helvetica, sans-serif;
                font-size: 1rem;

                &:focus {
                    outline: none;
                    border-bottom: 1px solid #0a0;
                }
            }
        </style>
    </head>
    <body>
        <div style="
            display: none;
            height: 100%;
            overflow: hidden;"
            id="pageHome">
            <div style="
                display: grid;
                grid-template-rows: max-content 1fr max-content;
                height: 100%;">
                <div style="
                    display: grid;
                    grid-template-columns: 1fr repeat(3, max-content);
                    border-bottom: 1px solid #0a0;">
                    <div style="
                        padding: 1rem;
                        font-weight: bold;">
                        Japanese Chatting Trainer <span style="color: #aaa; font-size: 0.7rem;">v0.1.0 by ionvop</span>
                    </div>
                    <div style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 1rem;"
                        onclick="home_btnNew_click()">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M440-440H240q-17 0-28.5-11.5T200-480q0-17 11.5-28.5T240-520h200v-200q0-17 11.5-28.5T480-760q17 0 28.5 11.5T520-720v200h200q17 0 28.5 11.5T760-480q0 17-11.5 28.5T720-440H520v200q0 17-11.5 28.5T480-200q-17 0-28.5-11.5T440-240v-200Z"/></svg>
                    </div>
                    <div style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 1rem;"
                        onclick="openPage('history')">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M480-120q-126 0-223-76.5T131-392q-4-15 6-27.5t27-14.5q16-2 29 6t18 24q24 90 99 147t170 57q117 0 198.5-81.5T760-480q0-117-81.5-198.5T480-760q-69 0-129 32t-101 88h70q17 0 28.5 11.5T360-600q0 17-11.5 28.5T320-560H160q-17 0-28.5-11.5T120-600v-160q0-17 11.5-28.5T160-800q17 0 28.5 11.5T200-760v54q51-64 124.5-99T480-840q75 0 140.5 28.5t114 77q48.5 48.5 77 114T840-480q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-120Zm40-376 100 100q11 11 11 28t-11 28q-11 11-28 11t-28-11L452-452q-6-6-9-13.5t-3-15.5v-159q0-17 11.5-28.5T480-680q17 0 28.5 11.5T520-640v144Z"/></svg>
                    </div>
                    <div style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 1rem;"
                        onclick="openPage('settings')">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M433-80q-27 0-46.5-18T363-142l-9-66q-13-5-24.5-12T307-235l-62 26q-25 11-50 2t-39-32l-47-82q-14-23-8-49t27-43l53-40q-1-7-1-13.5v-27q0-6.5 1-13.5l-53-40q-21-17-27-43t8-49l47-82q14-23 39-32t50 2l62 26q11-8 23-15t24-12l9-66q4-26 23.5-44t46.5-18h94q27 0 46.5 18t23.5 44l9 66q13 5 24.5 12t22.5 15l62-26q25-11 50-2t39 32l47 82q14 23 8 49t-27 43l-53 40q1 7 1 13.5v27q0 6.5-2 13.5l53 40q21 17 27 43t-8 49l-48 82q-14 23-39 32t-50-2l-60-26q-11 8-23 15t-24 12l-9 66q-4 26-23.5 44T527-80h-94Zm49-260q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Z"/></svg>
                    </div>
                </div>
                <div style="
                    overflow: auto;"
                    id="home_panelChat">

                </div>
                <div style="
                    display: grid;
                    grid-template-columns: 1fr max-content;
                    background-color: #222;">
                    <div style="
                        padding: 1rem;">
                        <textarea style="
                            height: 4rem;
                            resize: none;"
                            id="home_inputMessage"
                            oninput="home_inputMessage_input(this)"
                            placeholder="Enter your message..."></textarea>
                    </div>
                    <div style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 1rem;
                        padding-left: 0rem;"
                        id="home_panelSend">
                        <button onclick="home_btnSend_click()">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M176-183q-20 8-38-3.5T120-220v-180l320-80-320-80v-180q0-22 18-33.5t38-3.5l616 260q25 11 25 37t-25 37L176-183Z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div style="
            display: none;
            height: 100%;
            overflow: hidden;"
            id="pageHistory">
            <div style="
                display: grid;
                grid-template-rows: max-content 1fr;
                height: 100%;">
                <div style="
                    display: grid;
                    grid-template-columns: max-content 1fr max-content;
                    border-bottom: 1px solid #0a0;">
                    <div style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 1rem;"
                        onclick="openPage('home')">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="m313-440 196 196q12 12 11.5 28T508-188q-12 11-28 11.5T452-188L188-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l264-264q11-11 27.5-11t28.5 11q12 12 12 28.5T508-715L313-520h447q17 0 28.5 11.5T800-480q0 17-11.5 28.5T760-440H313Z"/></svg>
                    </div>
                    <div style="
                        padding: 1rem;
                        font-size: 1.5rem;
                        font-weight: bold;">
                        History
                    </div>
                    <div style="
                        padding: 1rem;"
                        onclick="history_btnClear_click()">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M280-120q-33 0-56.5-23.5T200-200v-520q-17 0-28.5-11.5T160-760q0-17 11.5-28.5T200-800h160q0-17 11.5-28.5T400-840h160q17 0 28.5 11.5T600-800h160q17 0 28.5 11.5T800-760q0 17-11.5 28.5T760-720v520q0 33-23.5 56.5T680-120H280Zm120-160q17 0 28.5-11.5T440-320v-280q0-17-11.5-28.5T400-640q-17 0-28.5 11.5T360-600v280q0 17 11.5 28.5T400-280Zm160 0q17 0 28.5-11.5T600-320v-280q0-17-11.5-28.5T560-640q-17 0-28.5 11.5T520-600v280q0 17 11.5 28.5T560-280Z"/></svg>
                    </div>
                </div>
                <div style="
                    padding: 1rem;"
                    id="history_panelHistory">

                </div>
            </div>
        </div>
        <div style="
            display: none;
            height: 100%;
            overflow: hidden;"
            id="pageSettings">
            <div style="
                display: grid;
                grid-template-rows: max-content 1fr;
                height: 100%;">
                <div style="
                    display: grid;
                    grid-template-columns: max-content 1fr;
                    border-bottom: 1px solid #0a0;">
                    <div style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 1rem;"
                        onclick="openPage('home')">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="m313-440 196 196q12 12 11.5 28T508-188q-12 11-28 11.5T452-188L188-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l264-264q11-11 27.5-11t28.5 11q12 12 12 28.5T508-715L313-520h447q17 0 28.5 11.5T800-480q0 17-11.5 28.5T760-440H313Z"/></svg>
                    </div>
                    <div style="
                        padding: 1rem;
                        font-size: 1.5rem;
                        font-weight: bold;">
                        Settings
                    </div>
                </div>
                <div style="
                    padding: 1rem;">
                    <div style="
                        padding: 1rem;">
                        OpenAI Endpoint URL
                    </div>
                    <div style="
                        padding: 1rem;
                        padding-top: 0rem;">
                        <input
                            id="settings_inputEndpoint"
                            onchange="settings_saveSettings()"
                            placeholder="https://api.openai.com/v1/chat/completions">
                    </div>
                    <div style="
                        padding: 1rem;">
                        OpenAI API Key
                    </div>
                    <div style="
                        padding: 1rem;
                        padding-top: 0rem;">
                        <input
                            type="password"
                            id="settings_inputApiKey"
                            onchange="settings_saveSettings()"
                            placeholder="sk-...">
                    </div>
                    <div style="
                        padding: 1rem;">
                        OpenAI Model
                    </div>
                    <div style="
                        padding: 1rem;
                        padding-top: 0rem;">
                        <input
                            id="settings_inputModel"
                            onchange="settings_saveSettings()"
                            placeholder="gpt-4o-mini">
                    </div>
                </div>
            </div>
        </div>
        <div style="
            display: none;
            height: 100%;
            overflow: hidden;"
            id="pageChat">
            <div style="
                display: grid;
                grid-template-rows: max-content 1fr max-content;
                height: 100%;">
                <div style="
                    display: grid;
                    grid-template-columns: max-content 1fr;
                    border-bottom: 1px solid #0a0;">
                    <div style="
                        padding: 1rem;"
                        onclick="if (confirm('Are you sure you want to return? You will lose your current progress.')) openPage('home')">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="m313-440 196 196q12 12 11.5 28T508-188q-12 11-28 11.5T452-188L188-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l264-264q11-11 27.5-11t28.5 11q12 12 12 28.5T508-715L313-520h447q17 0 28.5 11.5T800-480q0 17-11.5 28.5T760-440H313Z"/></svg>
                    </div>
                    <div style="
                        padding: 1rem;
                        font-size: 1.5rem;
                        font-weight: bold;"
                        id="chat_panelName">
                        
                    </div>
                </div>
                <div style="
                    overflow: auto;">
                    <div style="
                        padding: 1rem;"
                        id="chat_panelScenario">

                    </div>
                    <div id="chat_panelChat">

                    </div>
                </div>
                <div style="
                    display: grid;
                    grid-template-columns: 1fr max-content;
                    background-color: #222;"
                    id="chat_panelReply">
                    <div style="
                        padding: 1rem;">
                        <textarea style="
                            height: 4rem;
                            resize: none;"
                            id="chat_inputMessage"
                            oninput="chat_inputMessage_input(this)"
                            placeholder="Enter your message..."></textarea>
                    </div>
                    <div style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 1rem;
                        padding-left: 0rem;"
                        id="chat_panelSend">
                        <button onclick="chat_btnSend_click()">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M176-183q-20 8-38-3.5T120-220v-180l320-80-320-80v-180q0-22 18-33.5t38-3.5l616 260q25 11 25 37t-25 37L176-183Z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <script>
            if ("serviceWorker" in navigator) navigator.serviceWorker.register("service-worker.js");
            let pageHome = document.getElementById("pageHome");
            let home_panelChat = document.getElementById("home_panelChat");
            let home_panelSend = document.getElementById("home_panelSend");
            let pageHistory = document.getElementById("pageHistory");
            let history_panelHistory = document.getElementById("history_panelHistory");
            let pageSettings = document.getElementById("pageSettings");
            let settings_inputEndpoint = document.getElementById("settings_inputEndpoint");
            let settings_inputApiKey = document.getElementById("settings_inputApiKey");
            let settings_inputModel = document.getElementById("settings_inputModel");
            let pageChat = document.getElementById("pageChat");
            let chat_panelName = document.getElementById("chat_panelName");
            let chat_panelScenario = document.getElementById("chat_panelScenario");
            let chat_panelChat = document.getElementById("chat_panelChat");
            let chat_inputMessage = document.getElementById("chat_inputMessage");
            let chat_panelReply = document.getElementById("chat_panelReply");
            let chat_panelSend = document.getElementById("chat_panelSend");
            let currentChatIndex = -1;
            let currentMessages = [];
            let currentChatMessages = [];
            let data = loadData();
            openPage("home");

            function loadData() {
                let data = JSON.parse(localStorage.getItem("20250813_data"));
                if (data == null) data = {};
                if (data.endpointUrl == null) data.endpointUrl = "https://api.openai.com/v1/chat/completions";
                if (data.apiKey == null) data.apiKey = "";
                if (data.model == null) data.model = "gpt-4o-mini";
                if (data.chats == null) data.chats = [];

                for (let chat of data.chats) {
                    if (chat.date == null) chat.date = new Date().toLocaleString();
                    if (chat.messages == null) chat.messages = [];

                    for (let message of chat.messages) {
                        if (message.role == null) message.role = "user";
                        if (message.content == null) message.content = "";
                    }
                }

                localStorage.setItem("20250813_data", JSON.stringify(data));
                return data;
            }

            function elementFromHTML(html) {
                let template = document.createElement("template");
                template.innerHTML = html;
                return template.content.firstElementChild;
            }

            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function openPage(page) {
                pageHome.style.display = "none";
                pageHistory.style.display = "none";
                pageSettings.style.display = "none";
                pageChat.style.display = "none";

                switch (page) {
                    case "home": {
                        pageHome.style.display = "block";
                        home_panelChat.innerHTML = "";

                        if (currentChatIndex == -1) {
                            currentMessages = [
                                {
                                    role: "assistant",
                                    content: "Welcome to Japanese Chatting Trainer. Let's get started by telling me your proficiency level in Japanese and I will provide you with a scenario that will help you practice your skills."
                                }
                            ];
                        } else {
                            currentMessages = data.chats[currentChatIndex].messages;
                        }

                        for (let message of currentMessages) {
                            switch (message.role) {
                                case "user": {
                                    let messageElement = elementFromHTML(/*html*/`
                                        <div style="
                                            display: grid;
                                            grid-template-columns: 1fr minmax(0, max-content);">
                                            <div style="
                                                min-width: 1rem;">
                                                
                                            </div>
                                            <div style="
                                                padding: 1rem;">
                                                <div style="
                                                    padding: 1rem;
                                                    background-color: #555;
                                                    border-radius: 1rem;">
                                                    ${escapeHtml(message.content)}
                                                </div>
                                            </div>
                                        </div>
                                    `);

                                    home_panelChat.appendChild(messageElement);
                                } break;
                                case "assistant": {
                                    if (message.tool_calls != null) {
                                        let args = JSON.parse(message.tool_calls[0].function.arguments);

                                        let messageElement = elementFromHTML(/*html*/`
                                            <div style="
                                                display: grid;
                                                grid-template-columns: minmax(0, max-content) 1fr;">
                                                <div style="
                                                    padding: 1rem;">
                                                    <div style="
                                                        background-color: #050;
                                                        border-radius: 1rem;">
                                                        <div style="
                                                            padding: 1rem;
                                                            font-size: 1.5rem;
                                                            font-weight: bold;">
                                                            ${escapeHtml(args.name)}
                                                        </div>
                                                        <div style="
                                                            padding: 1rem;
                                                            padding-top: 0rem;">
                                                            ${escapeHtml(args.scenario)}
                                                        </div>
                                                        <div style="
                                                            padding: 1rem;
                                                            padding-top: 0rem;">
                                                            <button style="
                                                                background-color: #fff;
                                                                color: #000;
                                                                width: 100%;"
                                                                onclick="home_btnStart_click(this)"
                                                                data-index="${currentMessages.indexOf(message)}">
                                                                Start Chat
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div style="
                                                    min-width: 5rem;">
                                                    
                                                </div>
                                            </div>
                                        `);

                                        home_panelChat.appendChild(messageElement);
                                        break;
                                    }

                                    let messageElement = elementFromHTML(/*html*/`
                                        <div style="
                                            display: grid;
                                            grid-template-columns: minmax(0, max-content) 1fr;">
                                            <div style="
                                                padding: 1rem;">
                                                <div style="
                                                    padding: 1rem;
                                                    background-color: #050;
                                                    border-radius: 1rem;">
                                                    ${escapeHtml(message.content)}
                                                </div>
                                            </div>
                                            <div style="
                                                min-width: 5rem;">
                                                
                                            </div>
                                        </div>
                                    `);

                                    home_panelChat.appendChild(messageElement);
                                } break;
                            }
                        }

                        home_panelChat.scrollTop = home_panelChat.scrollHeight;
                    } break;
                    case "history": {
                        pageHistory.style.display = "block";
                        chat_panelReply.style.display = "block";
                        history_panelHistory.innerHTML = "";

                        for (let chat of data.chats) {
                            let messageCount = chat.messages.length;

                            let chatElement = elementFromHTML(/*html*/`
                                <div style="
                                    padding: 1rem;">
                                    <div style="
                                        display: grid;
                                        grid-template-columns: 1fr max-content;
                                        border-bottom: 1px solid #0a0;">
                                        <div style="
                                            padding: 1rem;"
                                            onclick="history_btnChat_click(this)"
                                            data-index="${data.chats.indexOf(chat)}">
                                            ${escapeHtml(chat.date)} | ${messageCount} messages
                                        </div>
                                        <div style="
                                            padding: 1rem;"
                                            onclick="history_btnDelete_click(this)"
                                            data-index="${data.chats.indexOf(chat)}">
                                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M240-440q-17 0-28.5-11.5T200-480q0-17 11.5-28.5T240-520h480q17 0 28.5 11.5T760-480q0 17-11.5 28.5T720-440H240Z"/></svg>
                                        </div>
                                    </div>
                                </div>
                            `);

                            history_panelHistory.appendChild(chatElement);
                        }
                    } break;
                    case "settings": {
                        pageSettings.style.display = "block";
                        settings_inputEndpoint.value = data.endpointUrl;
                        settings_inputApiKey.value = data.apiKey;
                        settings_inputModel.value = data.model;
                    } break;
                    case "chat": {
                        pageChat.style.display = "block";
                        chat_panelChat.innerHTML = "";

                        for (let message of currentChatMessages) {
                            switch (message.role) {
                                case "user": {
                                    let messageElement = elementFromHTML(/*html*/`
                                        <div style="
                                            display: grid;
                                            grid-template-columns: 1fr minmax(0, max-content);">
                                            <div style="
                                                min-width: 1rem;">
                                                
                                            </div>
                                            <div style="
                                                padding: 1rem;">
                                                <div style="
                                                    padding: 1rem;
                                                    background-color: #555;
                                                    border-radius: 1rem;">
                                                    ${escapeHtml(message.content)}
                                                </div>
                                            </div>
                                        </div>
                                    `);

                                    chat_panelChat.appendChild(messageElement);
                                } break;
                                case "assistant": {
                                    let messageElement = elementFromHTML(/*html*/`
                                        <div style="
                                            display: grid;
                                            grid-template-columns: minmax(0, max-content) 1fr;">
                                            <div style="
                                                padding: 1rem;">
                                                <div style="
                                                    padding: 1rem;
                                                    background-color: #050;
                                                    border-radius: 1rem;">
                                                    ${escapeHtml(message.content)}
                                                </div>
                                            </div>
                                            <div style="
                                                min-width: 5rem;">
                                                
                                            </div>
                                        </div>
                                    `);

                                    chat_panelChat.appendChild(messageElement);
                                } break;
                            }
                        }
                    } break;
                }
            }

            function home_inputMessage_input(element) {
                element.style.height = "auto";

                if (element.scrollHeight > 300) {
                    element.style.height = "300px";
                } else {
                    element.style.height = element.scrollHeight + "px";
                }
            }

            function home_btnNew_click() {
                currentChatIndex = -1;
                openPage("home");
            }

            async function home_btnSend_click() {
                let message = {
                    role: "user",
                    content: home_inputMessage.value
                };

                currentMessages.push(message);

                if (currentChatIndex == -1) {
                    data.chats.splice(0, 0, {
                        date: new Date().toLocaleString(),
                        messages: currentMessages
                    });

                    currentChatIndex = 0;
                } else {
                    data.chats[currentChatIndex].messages = currentMessages;
                }

                home_inputMessage.value = "";

                let messages = currentMessages.map(message => {
                    return {
                        role: message.role,
                        content: message.content
                    };
                });

                let originalPanelSend = home_panelSend.innerHTML;

                home_panelSend.innerHTML = /*html*/ `
                    <svg width="24px" height="24px" fill="#e3e3e3" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,4a8,8,0,0,1,7.89,6.7A1.53,1.53,0,0,0,21.38,12h0a1.5,1.5,0,0,0,1.48-1.75,11,11,0,0,0-21.72,0A1.5,1.5,0,0,0,2.62,12h0a1.53,1.53,0,0,0,1.49-1.3A8,8,0,0,1,12,4Z"><animateTransform attributeName="transform" type="rotate" dur="0.75s" values="0 12 12;360 12 12" repeatCount="indefinite"/></path></svg>
                `;

                let tools = [
                    {
                        type: "function",
                        function: {
                            name: "newChatLesson",
                            description: "Create a new goal-oriented conversation that the user must complete.",
                            parameters: {
                                type: "object",
                                properties: {
                                    name: {
                                        type: "string",
                                        description: "The name of the AI that the user will be interacting with."
                                    },
                                    scenario: {
                                        type: "string",
                                        description: "The scenario that the conversation takes place in."
                                    },
                                    goal: {
                                        type: "string",
                                        description: "The conversation will end in success if the user achieves this goal."
                                    },
                                    instructions: {
                                        type: "string",
                                        description: "These are instructions that the AI must follow such as whether to include English translations or not, how strict or lenient the AI is in marking the conversation as success or failure, etc."
                                    },
                                    firstMessage: {
                                        type: "string",
                                        description: "The first message that the user will see."
                                    }
                                },
                                required: ["name", "scenario", "goal", "firstMessage"]
                            }
                        }
                    }
                ];

                openPage("home");

                let response = await fetch(data.endpointUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${data.apiKey}`
                    },
                    body: JSON.stringify({
                        model: data.model,
                        messages: messages,
                        tools: tools
                    })
                });

                response = await response.json();
                home_panelSend.innerHTML = originalPanelSend;
                currentMessages.push(response.choices[0].message);

                if (currentChatIndex == -1) {
                    data.chats.splice(0, 0, {
                        date: new Date().toLocaleString(),
                        messages: currentMessages
                    });

                    currentChatIndex = 0;
                } else {
                    data.chats[currentChatIndex].messages = currentMessages;
                }

                localStorage.setItem("20250813_data", JSON.stringify(data));
                openPage("home");
            }

            function home_btnStart_click(element) {
                let index = parseInt(element.dataset.index);
                let message = currentMessages[index];
                let args = JSON.parse(message.tool_calls[0].function.arguments);
                chat_panelName.textContent = args.name;
                chat_panelScenario.textContent = args.scenario;

                currentChatMessages = [
                    {
                        role: "system",
                        content: `You are ${args.name}.\n\n\n\nScenario of the user: ${args.scenario}.\n\n\n\nGoal that the user must achieve: ${args.goal}.\n\n\n\nInstructions for the AI: ${args.instructions}\n\n\n\nThe user must try to speak only in Japanese as much as possible.`
                    },
                    {
                        role: "assistant",
                        content: args.firstMessage
                    }
                ];

                openPage("chat");
                alert(args.goal);
            }

            function history_btnClear_click() {
                if (confirm("Are you sure you want to clear all history?") == false) return;
                data.chats = [];
                currentChatIndex = -1;
                localStorage.setItem("20250813_data", JSON.stringify(data));
                openPage("history");
            }

            function history_btnChat_click(element) {
                currentChatIndex = parseInt(element.dataset.index);
                openPage("home");
            }

            function history_btnDelete_click(element) {
                if (confirm("Are you sure you want to delete this chat?") == false) return;
                let index = parseInt(element.dataset.index);
                data.chats.splice(index, 1);
                currentChatIndex = -1;
                localStorage.setItem("20250813_data", JSON.stringify(data));
                openPage("history");
            }

            function settings_saveSettings() {
                data.endpointUrl = settings_inputEndpoint.value;
                data.apiKey = settings_inputApiKey.value;
                data.model = settings_inputModel.value;
                localStorage.setItem("20250813_data", JSON.stringify(data));
            }

            function chat_inputMessage_input(element) {
                element.style.height = "auto";

                if (element.scrollHeight > 300) {
                    element.style.height = "300px";
                } else {
                    element.style.height = element.scrollHeight + "px";
                }
            }

            async function chat_btnSend_click() {
                let message = {
                    role: "user",
                    content: chat_inputMessage.value
                };

                currentChatMessages.push(message);
                chat_inputMessage.value = "";

                let messages = currentChatMessages.map(message => {
                    return {
                        role: message.role,
                        content: message.content
                    };
                });

                let originalPanelSend = chat_panelSend.innerHTML;

                chat_panelSend.innerHTML = /*html*/ `
                    <svg width="24px" height="24px" fill="#e3e3e3" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,4a8,8,0,0,1,7.89,6.7A1.53,1.53,0,0,0,21.38,12h0a1.5,1.5,0,0,0,1.48-1.75,11,11,0,0,0-21.72,0A1.5,1.5,0,0,0,2.62,12h0a1.53,1.53,0,0,0,1.49-1.3A8,8,0,0,1,12,4Z"><animateTransform attributeName="transform" type="rotate" dur="0.75s" values="0 12 12;360 12 12" repeatCount="indefinite"/></path></svg>
                `;

                let tools = [
                    {
                        type: "function",
                        function: {
                            name: "completeChat",
                            description: "Call this if the user has achieved their goal.",
                            parameters: {
                                type: "object",
                                properties: {
                                    successMessage: {
                                        type: "string",
                                        description: "The message to send to the user."
                                    }
                                },
                                required: ["successMessage"]
                            }
                        }
                    },
                    {
                        type: "function",
                        function: {
                            name: "failChat",
                            description: "Call this if the user has gone too far from their goal.",
                            parameters: {
                                type: "object",
                                properties: {
                                    failMessage: {
                                        type: "string",
                                        description: "The message to send to the user."
                                    },
                                    reason: {
                                        type: "string",
                                        description: "The reason for the failure, as well as an advice on how the user can improve."
                                    }
                                },
                                required: ["failMessage"]
                            }
                        }
                    }
                ];

                openPage("chat");

                let response = await fetch(data.endpointUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${data.apiKey}`
                    },
                    body: JSON.stringify({
                        model: data.model,
                        messages: messages,
                        tools: tools
                    })
                });

                response = await response.json();
                chat_panelSend.innerHTML = originalPanelSend;

                if (response.choices[0].message.tool_calls != null) {
                    let functionName = response.choices[0].message.tool_calls[0].function.name;
                    let args = JSON.parse(response.choices[0].message.tool_calls[0].function.arguments);

                    switch (functionName) {
                        case "completeChat": {
                            alert(args.successMessage);
                            chat_panelReply.style.display = "none";
                        } break;
                        case "failChat": {
                            alert(`${args.failMessage}\n\n${args.reason}`);
                            chat_panelReply.style.display = "none";
                        } break;
                    }

                    return;
                }

                currentChatMessages.push(response.choices[0].message);
                openPage("chat");
            }
        </script>
    </body>
</html>